<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Ally Bank</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-page">
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container nav-container">
      <div class="logo">
        <h2>Ally<span>Bank</span></h2>
      </div>
      <ul class="nav-links">
        <li><a href="#" onclick="navigateSecure(event, 'index.html')">Home</a></li>
        <li><a href="#" onclick="navigateSecure(event, 'accounts.html')">Accounts</a></li>
        <li><a href="#" onclick="navigateSecure(event, 'savings.html')">Savings</a></li>
        <li><a href="#" onclick="navigateSecure(event, 'investing.html')">Investing</a></li>
        <li><a href="#" onclick="navigateSecure(event, 'support.html')">Support</a></li>
        <li><a href="#" id="logoutBtn" class="btn-login">Logout</a></li>
      </ul>
      <div class="mobile-menu-toggle">Menu</div>
    </div>
  </nav>

  <!-- Dynamic Greeting Header -->
  <header class="dashboard-header">
    <div class="container">
      <div class="greeting-container">
        <h1 id="dynamicGreeting">Welcome, <span id="userName"></span>!</h1>
        <p class="subtitle" id="greetingSubtitle">Your account is secure and ready.</p>
      </div>
      <p class="account-info">Account: <strong id="userAccNum"></strong></p>
    </div>
  </header>

  <!-- First-Time User Banner -->
  <div id="firstTimeBanner" class="banner info" style="display:none;">
    <div class="container">
      <div class="banner-content">
        <span class="icon">Lock</span>
        <div>
          <strong>Secure your account</strong><br>
          <small>Set your 4-digit PIN to enable transfers and payments.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <section class="dashboard-content">
    <div class="container">

      <!-- SHOW PROFILE BUTTON -->
      <div style="text-align:center; margin: 1.5rem 0;">
        <button class="show-profile-btn" onclick="toggleProfile()">Show Profile</button>
      </div>

      <div class="dashboard-grid">
        <!-- USER PROFILE CARD (HIDDEN BY DEFAULT) -->
        <div class="card profile-card">
          <div class="card-header">
            <h3>User Profile</h3>
            <button class="btn-icon" onclick="openEditProfile()">Edit</button>
          </div>
          <div class="card-body">
            <div class="profile-avatar">
              <div class="avatar-circle">
                <span id="profileInitials"></span>
              </div>
            </div>
            <div class="profile-details">
              <p><strong>Full Name:</strong> <span id="profileName"></span></p>
              <p><strong>Email:</strong> <span id="profileEmail"></span></p>
              <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
              <p><strong>Address:</strong> <span id="profileAddress"></span></p>
              <p><strong>Date of Birth:</strong> <span id="profileDOB"></span></p>
              <p><strong>Account Created:</strong> <span id="profileCreated"></span></p>
            </div>
          </div>
        </div>

        <!-- Balance Card -->
        <div class="card balance-card">
          <div class="card-header">
            <h3>Available Balance</h3>
            <span class="badge success">Active</span>
          </div>
          <div class="card-body">
            <p class="balance-amount">$<span id="userBalance">0.00</span></p>
            <button class="btn-primary" onclick="openTransferModal()">Transfer Money</button>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card quick-actions">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div class="card-body">
            <div class="action-grid">
              <button class="action-btn" onclick="openPayBillModal()">Pay Bills</button>
              <button class="action-btn" onclick="openDepositModal()">Mobile Deposit</button>
              <button class="action-btn" onclick="openSendMoneyModal()">Send Money</button>
            </div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card transactions-card">
          <div class="card-header">
            <h3>Recent Transactions</h3>
            <a href="#" class="link-sm" onclick="openFullHistory()">View All</a>
          </div>
          <div class="card-body">
            <div id="transactionsList" class="transactions-list">
              <p class="no-data">No recent transactions.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="editName" required />
          </div>
          <div class="input-group">
            <label>Email</label>
            <input type="email" id="editEmail" required />
          </div>
          <div class="input-group">
            <label>Phone</label>
            <input type="tel" id="editPhone" placeholder="123-456-7890" required />
          </div>
          <div class="input-group">
            <label>Address</label>
            <input type="text" id="editAddress" required />
          </div>
          <div class="input-group">
            <label>Date of Birth</label>
            <input type="date" id="editDOB" required />
          </div>
          <button type="submit" class="btn-primary full">Save Changes</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div id="transferModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Transfer Money</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="transferForm">
          <div class="input-group">
            <label>Amount</label>
            <input type="number" id="transferAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>Recipient Account Number</label>
            <input type="text" id="transferAccNum" placeholder="1234567890" maxlength="10" required />
            <small style="color:#666; font-size:0.8em;">Exactly 10 digits</small>
          </div>
          <div class="input-group">
            <label>Recipient Full Name</label>
            <input type="text" id="transferName" placeholder="John Doe" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="transferPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Send Transfer</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content small">
      <div class="modal-header">
        <h2>Confirm Transfer</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <p><strong>To:</strong> <span id="confirmName"></span></p>
        <p><strong>Account:</strong> <span id="confirmAcc"></span></p>
        <p><strong>Amount:</strong> $<span id="confirmAmount"></span></p>
        <div class="btn-group">
          <button id="confirmBtn" class="btn-primary">Confirm</button>
          <button id="cancelBtn" class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pay Bill Modal -->
  <div id="payBillModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Pay Bill</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="payBillForm">
          <div class="input-group">
            <label>Payee</label>
            <input type="text" id="billPayee" placeholder="Electric Company" required />
          </div>
          <div class="input-group">
            <label>Amount</label>
            <input type="number" id="billAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="billPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Pay Now</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Mobile Deposit Modal -->
  <div id="depositModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Mobile Deposit</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="depositForm">
          <div class="input-group">
            <label>Check Amount</label>
            <input type="number" id="depositAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="depositPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Deposit Check</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Send Money Modal -->
  <div id="sendMoneyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Send Money</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <form id="sendMoneyForm">
          <div class="input-group">
            <label>Recipient Email</label>
            <input type="email" id="sendEmail" placeholder="friend@example.com" required />
          </div>
          <div class="input-group">
            <label>Amount</label>
            <input type="number" id="sendAmount" placeholder="0.00" step="0.01" min="0.01" required />
          </div>
          <div class="input-group">
            <label>4-Digit PIN</label>
            <input type="password" id="sendPin" maxlength="4" placeholder="••••" required />
          </div>
          <button type="submit" class="btn-primary full">Send</button>
        </form>
      </div>
    </div>
  </div>

  <!-- FULL TRANSACTION HISTORY MODAL -->
  <div id="fullHistoryModal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2>Full Transaction History</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <div id="fullTransactionsList" class="transactions-list full">
          <p class="no-data">No transactions yet.</p>
        </div>
        <div style="margin-top:1.5rem; text-align:center;">
          <button class="btn-secondary" onclick="closeModal()">Back to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRANSACTION RECEIPT MODAL -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Transaction Receipt</h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body receipt-body">
        <div class="receipt-header">
          <h3>Ally Bank</h3>
          <p>Digital Banking Receipt</p>
        </div>
        <div class="receipt-details">
          <p><strong>Reference ID:</strong> <span id="receiptRef"></span></p>
          <p><strong>Type:</strong> <span id="receiptType"></span></p>
          <p><strong>Amount:</strong> <span id="receiptAmount"></span></p>
          <p><strong>Date:</strong> <span id="receiptDate"></span></p>
          <p><strong>Description:</strong> <span id="receiptDesc"></span></p>
          <p><strong>Account:</strong> <span id="receiptAcc"></span></p>
          <p><strong>Status:</strong> <span class="badge success">Completed</span></p>
        </div>
        <div class="receipt-footer">
          <button class="btn-primary" onclick="printReceipt()">Print</button>
          <button class="btn-secondary" onclick="closeModal()">Back to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-container">
      <div class="footer-col">
        <div class="footer-logo">
          <h3>Ally<span>Bank</span></h3>
          <p>Digital banking. No nonsense.</p>
        </div>
      </div>
      <div class="footer-col">
        <h4>Products</h4>
        <ul>
          <li><a href="savings.html">Savings Accounts</a></li>
          <li><a href="accounts.html">Checking Accounts</a></li>
          <li><a href="investing.html">Certificates of Deposit</a></li>
          <li><a href="#">Auto Loans</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Company</h4>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Press</a></li>
          <li><a href="#">Investor Relations</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Contact</h4>
        <p>Email: <a href="mailto:allybank452@gmail.com">allybank452@gmail.com</a></p>
        <div class="social-links">
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">
        <p>&copy; 2025 Ally Bank. Member FDIC. Equal Housing Lender.</p>
        <div class="legal-links">
          <a href="privacy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Use</a>
          <a href="security.html">Security</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // GLOBAL DATA
    let USERS = [];
    let CURRENT_USER = null;
    let SELECTED_TX = null;

    // === SECURE NAVIGATION (KEEPS USER LOGGED IN) ===
    function navigateSecure(e, url) {
      e.preventDefault();
      if (CURRENT_USER) {
        sessionStorage.setItem('currentUser', JSON.stringify(CURRENT_USER));
      }
      window.location.href = url;
    }

    // Generate unique reference ID
    function generateRefId() {
      return 'TX' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 3).toUpperCase();
    }

    // === SAVE CURRENT_USER TO USERS ARRAY ===
    function saveCurrentUser() {
      const userIndex = USERS.findIndex(u => u.id === CURRENT_USER.id);
      if (userIndex !== -1) {
        USERS[userIndex] = { ...CURRENT_USER };
        localStorage.setItem('users', JSON.stringify(USERS));
        sessionStorage.setItem('currentUser', JSON.stringify(CURRENT_USER));
      }
    }

    // === TOGGLE PROFILE VISIBILITY ===
    function toggleProfile() {
      const profileCard = document.querySelector('.profile-card');
      const btn = document.querySelector('.show-profile-btn');
      
      if (profileCard.classList.contains('visible')) {
        profileCard.classList.remove('visible');
        btn.textContent = 'Show Profile';
      } else {
        profileCard.classList.add('visible');
        btn.textContent = 'Hide Profile';
      }
    }

    // Load user data
    document.addEventListener('DOMContentLoaded', () => {
      CURRENT_USER = JSON.parse(sessionStorage.getItem('currentUser'));
      if (!CURRENT_USER) {
        window.location.href = 'login.html';
        return;
      }

      USERS = JSON.parse(localStorage.getItem('users') || '[]');

      const storedUser = USERS.find(u => u.id === CURRENT_USER.id);
      if (storedUser) {
        CURRENT_USER = { ...storedUser };
        sessionStorage.setItem('currentUser', JSON.stringify(CURRENT_USER));
      }

      // Populate dashboard
      document.getElementById('userName').textContent = CURRENT_USER.name;
      document.getElementById('userAccNum').textContent = CURRENT_USER.accountNumber;
      document.getElementById('userBalance').textContent = parseFloat(CURRENT_USER.balance).toFixed(2);

      // Profile
      document.getElementById('profileName').textContent = CURRENT_USER.name;
      document.getElementById('profileEmail').textContent = CURRENT_USER.email;
      document.getElementById('profilePhone').textContent = CURRENT_USER.phone || 'Not set';
      document.getElementById('profileAddress').textContent = CURRENT_USER.address || 'Not set';
      document.getElementById('profileDOB').textContent = CURRENT_USER.dob ? new Date(CURRENT_USER.dob).toLocaleDateString() : 'Not set';
      document.getElementById('profileCreated').textContent = new Date(CURRENT_USER.createdAt).toLocaleDateString();

      const initials = CURRENT_USER.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      document.getElementById('profileInitials').textContent = initials;

      const hour = new Date().getHours();
      const timeGreeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';

      const greetingEl = document.getElementById('dynamicGreeting');
      const subtitleEl = document.getElementById('greetingSubtitle');
      const bannerEl = document.getElementById('firstTimeBanner');

      if (!CURRENT_USER.pin) {
        greetingEl.innerHTML = `Welcome, <span class="highlight">${CURRENT_USER.name}</span>!`;
        subtitleEl.textContent = "Let's secure your account with a PIN.";
        bannerEl.style.display = 'block';
      } else {
        greetingEl.innerHTML = `${timeGreeting}, <span class="highlight">${CURRENT_USER.name}</span>!`;
        subtitleEl.textContent = "Your account is secure and ready.";
        bannerEl.style.display = 'none';
      }

      loadTransactions();
    });

    function loadTransactions() {
      const list = document.getElementById('transactionsList');
      if (CURRENT_USER.transactions && CURRENT_USER.transactions.length > 0) {
        const sorted = [...CURRENT_USER.transactions].sort((a, b) => b.timestamp - a.timestamp);
        list.innerHTML = sorted.slice(0, 5).map((t, idx) => `
          <div class="transaction-item ${t.type}">
            <div class="transaction-info">
              <strong>${t.type === 'deposit' ? '+' : '-'}$${t.amount.toFixed(2)}</strong>
              <p>${t.desc}</p>
            </div>
            <small>${new Date(t.date).toLocaleDateString()}</small>
            <button class="btn-small" onclick="openReceipt(${idx})" style="margin-left: auto;">View Receipt</button>
          </div>
        `).join('');
      } else {
        list.innerHTML = '<p class="no-data">No recent transactions.</p>';
      }
    }

    // === OPEN RECEIPT MODAL ===
    window.openReceipt = function(txIndex) {
      SELECTED_TX = CURRENT_USER.transactions[txIndex];
      if (!SELECTED_TX.refId) {
        SELECTED_TX.refId = generateRefId();
        saveCurrentUser();
      }

      document.getElementById('receiptRef').textContent = SELECTED_TX.refId;
      document.getElementById('receiptType').textContent = SELECTED_TX.type.charAt(0).toUpperCase() + SELECTED_TX.type.slice(1);
      document.getElementById('receiptAmount').textContent = (SELECTED_TX.type === 'deposit' ? '+' : '-') + '$' + SELECTED_TX.amount.toFixed(2);
      document.getElementById('receiptDate').textContent = new Date(SELECTED_TX.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('receiptDesc').textContent = SELECTED_TX.desc;
      document.getElementById('receiptAcc').textContent = CURRENT_USER.accountNumber;

      openModal('receiptModal');
    };

    // Print receipt
    window.printReceipt = function() {
      const printContent = document.querySelector('.receipt-body').innerHTML;
      const win = window.open('', '', 'width=800,height=600');
      win.document.write(`
        <html>
          <head><title>Receipt - ${SELECTED_TX.refId}</title></head>
          <body style="font-family:Arial,sans-serif;padding:2rem;">${printContent}</body>
        </html>
      `);
      win.document.close();
      win.print();
    };

    // === PROFILE MODAL ===
    function openEditProfile() {
      document.getElementById('editName').value = CURRENT_USER.name;
      document.getElementById('editEmail').value = CURRENT_USER.email;
      document.getElementById('editPhone').value = CURRENT_USER.phone || '';
      document.getElementById('editAddress').value = CURRENT_USER.address || '';
      document.getElementById('editDOB').value = CURRENT_USER.dob || '';
      openModal('editProfileModal');
    }

    document.getElementById('editProfileForm').addEventListener('submit', e => {
      e.preventDefault();

      CURRENT_USER.name = document.getElementById('editName').value.trim();
      CURRENT_USER.email = document.getElementById('editEmail').value.trim();
      CURRENT_USER.phone = document.getElementById('editPhone').value.trim();
      CURRENT_USER.address = document.getElementById('editAddress').value.trim();
      CURRENT_USER.dob = document.getElementById('editDOB').value;

      saveCurrentUser();
      location.reload();
    });

    // === FULL HISTORY MODAL ===
    function openFullHistory() {
      const list = document.getElementById('fullTransactionsList');
      if (CURRENT_USER.transactions && CURRENT_USER.transactions.length > 0) {
        const sorted = [...CURRENT_USER.transactions].sort((a, b) => b.timestamp - a.timestamp);
        list.innerHTML = sorted.map((t, idx) => `
          <div class="transaction-item ${t.type}">
            <div class="transaction-info">
              <strong>${t.type === 'deposit' ? '+' : '-'}$${t.amount.toFixed(2)}</strong>
              <p>${t.desc}</p>
            </div>
            <small>${new Date(t.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</small>
            <button class="btn-small" onclick="openReceipt(${idx})" style="margin-left: auto;">View Receipt</button>
          </div>
        `).join('');
      } else {
        list.innerHTML = '<p class="no-data">No transactions yet.</p>';
      }
      openModal('fullHistoryModal');
    }

    // Modal functions
    function openModal(id) { 
      document.getElementById(id).classList.add('active'); 
    }
    function closeModal() { 
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); 
    }
    document.querySelectorAll('.modal .close').forEach(btn => btn.addEventListener('click', closeModal));
    window.addEventListener('click', e => { 
      if (e.target.classList.contains('modal')) closeModal(); 
    });

    function openTransferModal() { openModal('transferModal'); }
    function openPayBillModal() { openModal('payBillModal'); }
    function openDepositModal() { openModal('depositModal'); }
    function openSendMoneyModal() { openModal('sendMoneyModal'); }

    // === TRANSFER: ANY 10-DIGIT ACCOUNT ===
    let transferData = null;

    document.getElementById('transferForm').addEventListener('submit', e => {
      e.preventDefault();

      const amount = parseFloat(document.getElementById('transferAmount').value);
      const accNum = document.getElementById('transferAccNum').value.trim();
      const name = document.getElementById('transferName').value.trim();
      const pin = document.getElementById('transferPin').value;

      if (!amount || amount <= 0) return alert('Enter a valid amount');
      if (amount > 5000) return alert('Max transfer: $5,000');
      if (CURRENT_USER.balance < amount) return alert('Insufficient funds');
      if (!CURRENT_USER.pin || pin !== CURRENT_USER.pin) return alert('Incorrect PIN');
      if (!accNum || accNum.length !== 10 || !/^\d{10}$/.test(accNum)) return alert('Invalid account number. Must be exactly 10 digits.');
      if (!name) return alert('Enter recipient name');
      if (accNum === CURRENT_USER.accountNumber) return alert("You can't transfer to your own account");

      transferData = { amount, accNum, name };
      document.getElementById('confirmName').textContent = name;
      document.getElementById('confirmAcc').textContent = accNum;
      document.getElementById('confirmAmount').textContent = amount.toFixed(2);
      closeModal();
      openModal('confirmModal');
    });

    document.getElementById('confirmBtn').addEventListener('click', () => {
      if (!transferData) return;

      const { amount, accNum, name } = transferData;

      CURRENT_USER.balance -= amount;
      const refId = generateRefId();
      CURRENT_USER.transactions.unshift({
        type: 'withdraw',
        amount,
        date: new Date().toISOString().split('T')[0],
        desc: `To ${name} (${accNum})`,
        timestamp: Date.now(),
        refId
      });

      saveCurrentUser();

      alert(`$${amount.toFixed(2)} sent to ${name} (${accNum})! Ref: ${refId}`);
      closeModal();
      location.reload();
    });

    document.getElementById('cancelBtn').addEventListener('click', closeModal);

    // === PAY BILL ===
    document.getElementById('payBillForm').addEventListener('submit', e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('billAmount').value);
      const payee = document.getElementById('billPayee').value.trim();
      const pin = document.getElementById('billPin').value;

      if (amount <= 0 || amount > 10000) return alert('Bill amount must be $0.01–$10,000');
      if (CURRENT_USER.balance < amount) return alert('Insufficient funds');
      if (pin !== CURRENT_USER.pin) return alert('Incorrect PIN');

      CURRENT_USER.balance -= amount;
      const refId = generateRefId();
      CURRENT_USER.transactions.unshift({ 
        type: 'withdraw', 
        amount, 
        date: new Date().toISOString().split('T')[0], 
        desc: `Bill: ${payee}`, 
        timestamp: Date.now(),
        refId 
      });

      saveCurrentUser();

      alert(`$${amount} paid to ${payee}. Ref: ${refId}`);
      closeModal();
      location.reload();
    });

    // === MOBILE DEPOSIT ===
    document.getElementById('depositForm').addEventListener('submit', e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('depositAmount').value);
      const pin = document.getElementById('depositPin').value;

      if (amount <= 0 || amount > 5000) return alert('Deposit limit: $5,000');
      if (pin !== CURRENT_USER.pin) return alert('Incorrect PIN');

      CURRENT_USER.balance += amount;
      const refId = generateRefId();
      CURRENT_USER.transactions.unshift({ 
        type: 'deposit', 
        amount, 
        date: new Date().toISOString().split('T')[0], 
        desc: 'Mobile Deposit', 
        timestamp: Date.now(),
        refId 
      });

      saveCurrentUser();

      alert(`$${amount} deposited! Ref: ${refId}`);
      closeModal();
      location.reload();
    });

    // === SEND MONEY ===
    document.getElementById('sendMoneyForm').addEventListener('submit', e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('sendAmount').value);
      const email = document.getElementById('sendEmail').value.trim().toLowerCase();
      const pin = document.getElementById('sendPin').value;

      if (amount <= 0 || amount > 1000) return alert('Send limit: $1,000');
      if (CURRENT_USER.balance < amount) return alert('Insufficient funds');
      if (pin !== CURRENT_USER.pin) return alert('Incorrect PIN');

      const recipient = USERS.find(u => u.email === email);
      if (!recipient) return alert('User not found');

      CURRENT_USER.balance -= amount;
      recipient.balance = (parseFloat(recipient.balance) || 0) + amount;

      const refId = generateRefId();
      CURRENT_USER.transactions.unshift({ 
        type: 'withdraw', 
        amount, 
        date: new Date().toISOString().split('T')[0], 
        desc: `Sent to ${recipient.name}`, 
        timestamp: Date.now(),
        refId 
      });
      recipient.transactions.unshift({ 
        type: 'deposit', 
        amount, 
        date: new Date().toISOString().split('T')[0], 
        desc: `From ${CURRENT_USER.name}`, 
        timestamp: Date.now(),
        refId 
      });

      const senderIndex = USERS.findIndex(u => u.id === CURRENT_USER.id);
      const recipientIndex = USERS.findIndex(u => u.id === recipient.id);
      if (senderIndex !== -1) USERS[senderIndex] = CURRENT_USER;
      if (recipientIndex !== -1) USERS[recipientIndex] = recipient;

      localStorage.setItem('users', JSON.stringify(USERS));
      sessionStorage.setItem('currentUser', JSON.stringify(CURRENT_USER));

      alert(`$${amount} sent to ${recipient.name}! Ref: ${refId}`);
      closeModal();
      location.reload();
    });

    // Mobile menu
    document.querySelector('.mobile-menu-toggle').addEventListener('click', () => {
      document.querySelector('.nav-links').classList.toggle('active');
    });
    document.querySelectorAll('.nav-links a').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelector('.nav-links').classList.remove('active');
      });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      sessionStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>